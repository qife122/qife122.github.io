<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>服务隔离 on 办公AI智能小助手</title>
        <link>http://localhost:1313/tags/%E6%9C%8D%E5%8A%A1%E9%9A%94%E7%A6%BB/</link>
        <description>Recent content in 服务隔离 on 办公AI智能小助手</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <copyright>qife</copyright>
        <lastBuildDate>Thu, 07 Aug 2025 04:30:33 +0800</lastBuildDate><atom:link href="http://localhost:1313/tags/%E6%9C%8D%E5%8A%A1%E9%9A%94%E7%A6%BB/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>服务隔离技术解析：Windows服务安全与权限提升漏洞分析</title>
        <link>http://localhost:1313/p/%E6%9C%8D%E5%8A%A1%E9%9A%94%E7%A6%BB%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90windows%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8%E4%B8%8E%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</link>
        <pubDate>Thu, 07 Aug 2025 04:30:33 +0800</pubDate>
        
        <guid>http://localhost:1313/p/%E6%9C%8D%E5%8A%A1%E9%9A%94%E7%A6%BB%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90windows%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8%E4%B8%8E%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</guid>
        <description>&lt;h2 id=&#34;服务隔离技术说明&#34;&gt;服务隔离技术说明
&lt;/h2&gt;&lt;p&gt;过去几天，在Cesar Cerrudo发布概念验证代码后，服务隔离问题成为我们关注的重点。IIS团队的Nazim Lala已发布详细博客说明修复方案及耗时原因。该补丁的代码修改量预计接近XP SP2级别，我们需要将Vista服务加固的大量基础设施工作回溯移植到旧版本系统，这对安全更新而言是项浩大工程。&lt;/p&gt;
&lt;h3 id=&#34;受影响用户范围&#34;&gt;受影响用户范围
&lt;/h3&gt;&lt;p&gt;攻击者需要满足以下条件才能利用此漏洞：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;在Windows服务上下文中执行代码&lt;/li&gt;
&lt;li&gt;进程令牌需具备SeImpersonatePrivilege权限&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;典型攻击场景包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;托管服务商运行不可信代码的IIS环境&lt;/li&gt;
&lt;li&gt;SQL Server场景中，数据库管理员拥有数据库权限但无主机权限&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;检测方法&#34;&gt;检测方法
&lt;/h3&gt;&lt;p&gt;使用Process Explorer检查运行不可信代码的进程令牌：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;双击目标进程&lt;/li&gt;
&lt;li&gt;查看&amp;quot;Security&amp;quot;标签页&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;示例1：以NETWORK SERVICE身份运行的Svchost
![Svchost进程示例]&lt;/p&gt;
&lt;p&gt;示例2：以普通用户身份运行的cmd.exe
![cmd进程示例]&lt;/p&gt;
&lt;h3 id=&#34;漏洞触发条件&#34;&gt;漏洞触发条件
&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;进程令牌具有SeImpersonatePrivilege权限&lt;/li&gt;
&lt;li&gt;进程运行权限低于SYSTEM级别&lt;/li&gt;
&lt;li&gt;进程执行不可信代码或允许不可信用户执行代码&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;符合条件的环境请务必参考[安全建议951306]实施缓解措施。&lt;/p&gt;
&lt;p&gt;&lt;em&gt;本文档按&amp;quot;原样&amp;quot;提供，不提供任何担保。&lt;/em&gt;&lt;/p&gt;
</description>
        </item>
        <item>
        <title>Windows登录会话共享漏洞：突破服务加固隔离的技术分析</title>
        <link>http://localhost:1313/p/windows%E7%99%BB%E5%BD%95%E4%BC%9A%E8%AF%9D%E5%85%B1%E4%BA%AB%E6%BC%8F%E6%B4%9E%E7%AA%81%E7%A0%B4%E6%9C%8D%E5%8A%A1%E5%8A%A0%E5%9B%BA%E9%9A%94%E7%A6%BB%E7%9A%84%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/</link>
        <pubDate>Sat, 02 Aug 2025 02:55:08 +0800</pubDate>
        
        <guid>http://localhost:1313/p/windows%E7%99%BB%E5%BD%95%E4%BC%9A%E8%AF%9D%E5%85%B1%E4%BA%AB%E6%BC%8F%E6%B4%9E%E7%AA%81%E7%A0%B4%E6%9C%8D%E5%8A%A1%E5%8A%A0%E5%9B%BA%E9%9A%94%E7%A6%BB%E7%9A%84%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/</guid>
        <description>&lt;h3 id=&#34;windows登录会话的过度共享&#34;&gt;Windows登录会话的过度共享
&lt;/h3&gt;&lt;p&gt;Windows的登录会话通常与单个经过身份验证的用户及其令牌绑定。然而对于服务账户而言情况并非如此——在服务加固机制下，同一个登录会话中可能存在多个带有不同服务组的令牌。本文将展示这种共享机制如何破坏服务加固的隔离性（至少对NETWORK SERVICE账户有效），并再次强调S-1-1-0并非安全边界。&lt;/p&gt;
&lt;h4 id=&#34;技术核心lsass令牌缓存机制&#34;&gt;技术核心：LSASS令牌缓存机制
&lt;/h4&gt;&lt;p&gt;当LSASS为新登录会话创建令牌时，会存储该令牌以供后续检索。虽然大多数场景下这个机制无显著作用，但在网络认证时会被重新启用。观察&lt;code&gt;AcquireCredentialsHandle&lt;/code&gt;API的原型时会发现&lt;code&gt;pvLogonID&lt;/code&gt;参数，其说明指出：&lt;/p&gt;
&lt;p&gt;&amp;ldquo;指向标识用户的本地唯一标识符(LUID)。此参数为文件系统进程（如网络重定向器）提供。该参数可为NULL。&amp;rdquo;&lt;/p&gt;
&lt;p&gt;拥有TCB权限时，此参数可指定用于网络认证的登录会话ID（从令牌视角看即认证ID）。虽然常规网络认证中令牌无法跨机器跟随，但在&lt;strong&gt;本地环回认证&lt;/strong&gt;场景下，服务端协商获得的令牌将是会话令牌而非调用方令牌。&lt;/p&gt;
&lt;h4 id=&#34;利用smb实现权限提升&#34;&gt;利用SMB实现权限提升
&lt;/h4&gt;&lt;p&gt;关键线索在于说明中的&amp;quot;网络重定向器&amp;quot;。最易访问且支持本地环回认证的重定向器是什么？&lt;strong&gt;SMB协议&lt;/strong&gt;。它是否提供获取网络认证令牌的原语？&lt;strong&gt;命名管道&lt;/strong&gt;。SMB是否以内核模式进行网络认证从而具备TCB特权？确实如此。&lt;/p&gt;
&lt;h4 id=&#34;漏洞复现windows-10-1909环境&#34;&gt;漏洞复现（Windows 10 1909环境）
&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;首先需要NETWORK SERVICE权限的PowerShell进程（可通过作者前文方法实现）&lt;/li&gt;
&lt;li&gt;创建命名管道并监听连接：
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$pipe&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;New-NtNamedPipeFile&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;\\.\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pipe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ABC&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Win32Path&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$job&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;Start-Job&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$pipe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Listen&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;通过本地主机访问管道：
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$file&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;Get-NtFile&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;\\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;localhost&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pipe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ABC&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Win32Path&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nb&#34;&gt;Wait-Job&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$job&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;Out-Null&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;在模拟命名管道时打开RPCSS进程：
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$p&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;Use-NtObject&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$pipe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Impersonate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;nb&#34;&gt;Get-NtProcess&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-ProcessId&lt;/span&gt; &lt;span class=&#34;mf&#34;&gt;1152&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;此时获得的访问权限为&lt;code&gt;AllAccess&lt;/code&gt;，因为LSASS存储的是该登录会话中首个令牌（即RPCSS进程的令牌）。&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;技术验证&#34;&gt;技术验证
&lt;/h4&gt;&lt;p&gt;检查模拟令牌的组列表可确认该令牌属于RPCSS服务：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$token&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;Use-NtObject&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$pipe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Impersonate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;nb&#34;&gt;Get-NtToken&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Impersonation&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$token&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Groups&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;?&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Name&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-Match&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Rpcss&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;输出显示&lt;code&gt;NT SERVICE\RpcSs&lt;/code&gt;组的存在，证实了令牌来源。&lt;/p&gt;
&lt;h4 id=&#34;影响范围&#34;&gt;影响范围
&lt;/h4&gt;&lt;p&gt;此特性存在于所有登录会话，但普通用户会话的利用价值较低。需注意的是：当以NETWORK SERVICE身份访问管理共享时，实际会以RPCSS服务身份认证，可能访问该服务SID创建的文件。本文仅抛砖引玉，相信读者能发掘更多创造性利用方式。&lt;/p&gt;
</description>
        </item>
        
    </channel>
</rss>
