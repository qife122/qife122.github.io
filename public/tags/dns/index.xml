<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>DNS on 办公AI智能小助手</title>
        <link>http://localhost:1313/tags/dns/</link>
        <description>Recent content in DNS on 办公AI智能小助手</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <copyright>qife</copyright>
        <lastBuildDate>Sat, 09 Aug 2025 02:58:14 +0800</lastBuildDate><atom:link href="http://localhost:1313/tags/dns/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>Mozilla以隐私之名推出劫持所有DNS流量的机制</title>
        <link>http://localhost:1313/p/mozilla%E4%BB%A5%E9%9A%90%E7%A7%81%E4%B9%8B%E5%90%8D%E6%8E%A8%E5%87%BA%E5%8A%AB%E6%8C%81%E6%89%80%E6%9C%89dns%E6%B5%81%E9%87%8F%E7%9A%84%E6%9C%BA%E5%88%B6/</link>
        <pubDate>Sat, 09 Aug 2025 02:58:14 +0800</pubDate>
        
        <guid>http://localhost:1313/p/mozilla%E4%BB%A5%E9%9A%90%E7%A7%81%E4%B9%8B%E5%90%8D%E6%8E%A8%E5%87%BA%E5%8A%AB%E6%8C%81%E6%89%80%E6%9C%89dns%E6%B5%81%E9%87%8F%E7%9A%84%E6%9C%BA%E5%88%B6/</guid>
        <description>&lt;p&gt;2019年9月，Mozilla开始通过其可信递归解析器（TRR）计划在Firefox中发布基于HTTPS的DNS（DoH）。这项变更基于两个常见论点：a) 旧协议未考虑安全性和隐私性；b) 存在他人窥探用户搜索内容的风险。&lt;/p&gt;
&lt;p&gt;技术层面，我对提供DoH功能没有异议，但质疑是否应将系统级控制权转移到Web层。真正令人担忧的是其默认启用的实现方式——未经用户同意即开启，并默认将Cloudflare作为DoH服务提供商。这意味着所有Firefox请求都将流向用户未自主选择的私营机构。&lt;/p&gt;
&lt;p&gt;相比之下，Google的实施方案默认为关闭状态，并允许用户自选DoH提供商。&lt;/p&gt;
&lt;h3 id=&#34;mozilla-doh实施的影响&#34;&gt;Mozilla DoH实施的影响
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;教育机构&lt;/strong&gt;：校园DNS过滤系统将失效，学生可绕过恶意网站/色情内容拦截&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;家长控制&lt;/strong&gt;：家庭网络防护工具形同虚设&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;企业安全&lt;/strong&gt;：安全团队无法监控网络流量中的恶意行为&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;政府监管&lt;/strong&gt;：阻碍ISP对儿童色情等非法内容的追责&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;应对方案&#34;&gt;应对方案
&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;网络级拦截&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;通过DNS查询&amp;quot;use-application-dns.net&amp;quot;返回NXDOMAIN或空记录&lt;/li&gt;
&lt;li&gt;注意：手动启用DoH的用户会绕过该限制&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Firefox设置禁用&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;进入首选项 &amp;gt; 网络设置&lt;/li&gt;
&lt;li&gt;取消勾选&amp;quot;启用基于HTTPS的DNS&amp;quot;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;卸载Firefox&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;部分企业CISO考虑完全移除Firefox，视其为未经授权的VPN&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;技术演进争议&#34;&gt;技术演进争议
&lt;/h3&gt;&lt;p&gt;DNS作为互联网关键组件正在变革，技术社区对实现更安全私密的网络存在共识，但具体实施方式存在根本分歧。未来将深入探讨不同方案间的技术细节与社区政治因素。&lt;/p&gt;
</description>
        </item>
        <item>
        <title>WSL2 DNS解析异常问题分析</title>
        <link>http://localhost:1313/p/wsl2-dns%E8%A7%A3%E6%9E%90%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</link>
        <pubDate>Fri, 08 Aug 2025 23:12:22 +0800</pubDate>
        
        <guid>http://localhost:1313/p/wsl2-dns%E8%A7%A3%E6%9E%90%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</guid>
        <description>&lt;h1 id=&#34;wsl2-dns解析异常&#34;&gt;WSL2 DNS解析异常
&lt;/h1&gt;&lt;p&gt;昨晚我在给服务器打补丁时遇到了看似DNS劫持的现象，经过调查发现这实际上是WSL2的一个异常行为。&lt;/p&gt;
&lt;h2 id=&#34;正常dns查询解析&#34;&gt;正常DNS查询解析
&lt;/h2&gt;&lt;p&gt;在标准Linux主机上使用dig进行DNS查询时，响应通常包含几个部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;QUESTION：查询的问题&lt;/li&gt;
&lt;li&gt;ANSWER：回答部分&lt;/li&gt;
&lt;li&gt;AUTHORITY：权威服务器列表&lt;/li&gt;
&lt;li&gt;ADDITIONAL：附加信息&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;wsl2的异常行为&#34;&gt;WSL2的异常行为
&lt;/h2&gt;&lt;p&gt;在WSL2环境下运行相同的查询时，发现E.ROOT-SERVERS.net和G.ROOT-SERVERS.net等本应出现在附加区的记录被错误地放入了回答区。通过数据包分析可见，WSL2的DNS服务器没有像标准DNS服务器那样正确区分各个区段。&lt;/p&gt;
&lt;h2 id=&#34;实际问题场景&#34;&gt;实际问题场景
&lt;/h2&gt;&lt;p&gt;作者在服务器升级后尝试SSH重连时遇到了异常：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;SSH客户端报告发现服务器新IP并要求验证签名&lt;/li&gt;
&lt;li&gt;实际上连接到了错误的内部IP（本应只在附加区出现的DNS服务器IP）&lt;/li&gt;
&lt;li&gt;问题表现为间歇性出现&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;技术分析&#34;&gt;技术分析
&lt;/h2&gt;&lt;p&gt;问题根源在于：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;SSH客户端进行DNS查询时获得两个回答（正确IP和错误IP）&lt;/li&gt;
&lt;li&gt;由于第一个IP无响应，客户端尝试了第二个错误IP&lt;/li&gt;
&lt;li&gt;该IP恰好运行着SSH服务，导致连接成功但连接到错误主机&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;安全影响评估&#34;&gt;安全影响评估
&lt;/h2&gt;&lt;p&gt;虽然理论上可能被恶意利用，但攻击者需要较高权限才能实现。作者已计划将该问题提交至WSL2的GitHub问题列表。&lt;/p&gt;
&lt;h2 id=&#34;总结&#34;&gt;总结
&lt;/h2&gt;&lt;p&gt;这个WSL2特有的DNS处理异常可能在某些环境下造成问题，特别是在自动化脚本或安全敏感场景中。虽然当前风险有限，但仍建议开发者注意此行为差异。&lt;/p&gt;
</description>
        </item>
        <item>
        <title>MS08-037：增强DNS解析器的随机性以提升安全性</title>
        <link>http://localhost:1313/p/ms08-037%E5%A2%9E%E5%BC%BAdns%E8%A7%A3%E6%9E%90%E5%99%A8%E7%9A%84%E9%9A%8F%E6%9C%BA%E6%80%A7%E4%BB%A5%E6%8F%90%E5%8D%87%E5%AE%89%E5%85%A8%E6%80%A7/</link>
        <pubDate>Fri, 08 Aug 2025 05:21:56 +0800</pubDate>
        
        <guid>http://localhost:1313/p/ms08-037%E5%A2%9E%E5%BC%BAdns%E8%A7%A3%E6%9E%90%E5%99%A8%E7%9A%84%E9%9A%8F%E6%9C%BA%E6%80%A7%E4%BB%A5%E6%8F%90%E5%8D%87%E5%AE%89%E5%85%A8%E6%80%A7/</guid>
        <description>&lt;p&gt;我们两个月前发布了安全公告MS08-020来改进DNS事务ID的随机性。您可以在&lt;a class=&#34;link&#34; href=&#34;https://example.com&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;这篇博客文章&lt;/a&gt;中阅读有关MS08-020算法更改的更多信息。增加随机性使攻击者更难伪造DNS响应。今天我们发布了MS08-037，进一步增加了伪造DNS事务的难度。&lt;/p&gt;
&lt;p&gt;我们修改了DNS客户端和服务器解析器，使其从随机源端口发送请求。以前，攻击者只需要猜测正确的事务ID。在应用MS08-037后，攻击者需要同时猜测事务ID和源端口才能成功伪造DNS响应。简而言之，DNS事务的随机源端口为DNS事务添加了另一个独特的信息片段，这使得伪造更加困难。&lt;/p&gt;
&lt;p&gt;在Win2k3及以下平台上，随机套接字池的默认大小为2500个端口，可以通过修改以下注册表值进行配置：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;HKLM\System\CurrentControlSet\Services\DNS\Parameters\SocketPoolSize
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;另一个值得注意的注册表值是：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;HKLM\CurrentControlset\services\tcpip\parameters\MaxUserPort
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;有关MaxUserPort的更多信息，请参考：&lt;a class=&#34;link&#34; href=&#34;http://technet2.microsoft.com/windowsserver/en/library/730fb465-d402-4853-bacc-16ba78e9fcc01033.mspx?mfr=true&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Microsoft Technet文档&lt;/a&gt;。在Win2k3上，MaxUserPort定义为通配符绑定可能分配的最大端口号。基本上，如果设置了MaxUserPort，它就定义了动态端口范围。需要注意的是，MaxUserPort在Vista和Win2k3中的含义不同。在Win2k3中，如果设置了MaxUserPort，它定义了动态端口范围（从1024到MaxUserPort）。在Vista中，如果设置了MaxUserPort，它表示动态端口的数量，因此范围是从StartRange（无论配置了什么，默认为49k）到StartRange+MaxUserPort。参考：&lt;a class=&#34;link&#34; href=&#34;http://support.microsoft.com/kb/929851&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Microsoft支持文档&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;总结来说，安装补丁后Win2k3及以下平台的固定行为是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果设置了MaxUserPort，则从1024-MaxUserPort范围内随机分配端口&lt;/li&gt;
&lt;li&gt;如果未设置MaxUserPort，则端口将从49152-65535范围内随机分配&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;默认端口池选择从与BSD传统一致的范围内随机获取端口，许多系统安全地从该范围动态分配端口。在该范围之外这样做有很小的可能导致网络故障，但在大多数情况下不会引起问题。如果您想增加随机性，可以通过修改MaxUserPort和相关注册表键来增加端口限制。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;安全漏洞研究与防御团队
&lt;em&gt;文章按&amp;quot;原样&amp;quot;提供，不提供任何担保，也不授予任何权利。&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
        </item>
        <item>
        <title>HTTPS上的DNS（DoH）乱局：加密与隐私的博弈</title>
        <link>http://localhost:1313/p/https%E4%B8%8A%E7%9A%84dnsdoh%E4%B9%B1%E5%B1%80%E5%8A%A0%E5%AF%86%E4%B8%8E%E9%9A%90%E7%A7%81%E7%9A%84%E5%8D%9A%E5%BC%88/</link>
        <pubDate>Tue, 05 Aug 2025 14:09:57 +0800</pubDate>
        
        <guid>http://localhost:1313/p/https%E4%B8%8A%E7%9A%84dnsdoh%E4%B9%B1%E5%B1%80%E5%8A%A0%E5%AF%86%E4%B8%8E%E9%9A%90%E7%A7%81%E7%9A%84%E5%8D%9A%E5%BC%88/</guid>
        <description>&lt;h3 id=&#34;https上的dnsdoh乱局&#34;&gt;HTTPS上的DNS（DoH）乱局
&lt;/h3&gt;&lt;p&gt;作者：Joff Thyer //&lt;/p&gt;
&lt;p&gt;这个周一早晨醒来时，我认为是时候重新审视我的家庭网络中的域名服务（DNS）配置了。（这个想法也源于2021年在内华达州雷诺市Wild West Hackin&amp;rsquo; Fest活动中与Paul Vixie的多次讨论。）&lt;/p&gt;
&lt;p&gt;背景而言，我从不认为应该依赖本地互联网服务提供商（ISP）的DNS基础设施。无意冒犯，但我始终认为ISP基础设施如同用胶带和铁丝勉强维系，而我向来是个喜欢&amp;quot;自己动手&amp;quot;的人。&lt;/p&gt;
&lt;p&gt;换句话说：&amp;ldquo;伙计们，只需给我光纤到以太网的接口，路由我的静态地址，传递我的数据包，剩下的交给我。&amp;ldquo;我很幸运找到一家恰好如此操作的ISP，他们甚至表示如果我拥有地址块，可以传递边界网关协议（BGP）表给我。这简直是天籁之音！&lt;/p&gt;
&lt;p&gt;毫不奇怪，我曾管理过拥有数千个端点的大型网络，而我的家庭网络也运行得井井有条。我自行部署路由、网络地址转换（NAT）、动态主机配置协议（DHCP）和DNS服务。只要上游正常传递数据包，我的网络就坚如磐石。&lt;/p&gt;
&lt;p&gt;现在进入令人不安的讨论。我们处于监控资本主义时代，全球互联网社区纵容众多公司通过挖掘我们持续产生的数据副产品牟利。&lt;/p&gt;
&lt;p&gt;DNS是互联网的基础设施，其设计本质就是高度分布式的！完全可以在自己的网络中运行DNS服务器，并通过DHCP告知网络端点：你的DNS才是域名到IP地址转换的正统之地。遗憾的是，家庭网络用户大多缺乏相关技能，只能依赖漏洞百出的家用路由器产品。&lt;/p&gt;
&lt;p&gt;当DNS遭遇监控资本主义，糟糕的事情就会发生。任何明文协议被网络嗅探并用于牟利时，你的隐私正在被侵犯，你正在成为巨额收入的来源。&lt;/p&gt;
&lt;p&gt;运行自己的DNS服务器有个微小优势：缓存机制。本地DNS服务器代表客户端存根解析器（端点）发出的请求都会带有生存时间（TTL）缓存值。你的DNS服务器会在TTL秒数内&amp;quot;记住&amp;quot;查询答案。&lt;/p&gt;
&lt;p&gt;如果不将所有请求转发给其他DNS提供商（如8.8.8.8），你的DNS服务器必须请求根域名服务器协助解析。下图展示了查询www.whitehouse.gov时本地DNS服务器的行为流程。&lt;/p&gt;
&lt;p&gt;问题何在？作为安全专业人士，我们热爱强加密，而DNS显然不够理想——它没有加密。DNSSEC？抱歉，它只确保应答准确性/防止欺骗，解决缓存中毒问题，但不保护传输中数据。&lt;/p&gt;
&lt;p&gt;各大浏览器厂商提出了有史以来最糟糕的解决方案：通过HTTPS传输DNS请求（RFC 8484）。HTTPS确实加密了，但请回想监控资本主义的问题——当DNS流量被发送到浏览器厂商的基础设施，你的数据反而更易被监控。这实际上导致了数据控制权的集中垄断！高度分布式架构的稳定性突然被少数巨头掌控，开放标准和自由互联网的原则正被数据挖掘者颠覆。&lt;/p&gt;
&lt;p&gt;从协议角度看，我们正在混淆流——HTTP是&amp;quot;超文本传输协议&amp;rdquo;，而DNS绝非超文本！结果形成了垂直协议栈的单一浏览器厂商锁定。这是我们想要的吗？这是正确的解决方案吗？&lt;/p&gt;
&lt;p&gt;我陷入深刻矛盾：强加密本是好事，安全专业人士理应支持经过验证的强加密，但当隐私被如此彻底侵犯时，我无法支持这种做法。更矛盾的是，我也无法确保本地ISP没有挖掘我的加密数据。&lt;/p&gt;
&lt;p&gt;另一种DNS加密形式DNS over TLS（DoT，RFC 7858）已存在多年。简言之，DoT至少在TCP 853端口建立适当的TLS服务，以标准合规方式实现加密。但DoT作为新协议面临实施挑战——如何让客户端存根解析器正确使用它？虽然可以通过DHCP选项配置，但仍需操作系统厂商在存根解析器代码中正确实现TLS支持。&lt;/p&gt;
&lt;p&gt;不出所料，&amp;ldquo;正确方案&amp;quot;往往不敌&amp;quot;便捷方案&amp;rdquo;。DoT需要大量改变，而人们厌恶改变——尤其是对DNS这种如电力般普及的基础服务。&lt;/p&gt;
&lt;p&gt;（数据监控话题需要公允看待）以下是主流DoH提供商列表，许多声称通过运营弹性和过滤恶意软件/广告域名提供增值服务：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;cloudflare-dns.com（隐私政策见其博客）&lt;/li&gt;
&lt;li&gt;dns.adguard.com（服务概述见其知识库）&lt;/li&gt;
&lt;li&gt;dns.google（将数据挖掘作为收入来源）&lt;/li&gt;
&lt;li&gt;dns.nextdns.io（见其隐私政策）&lt;/li&gt;
&lt;li&gt;dns.opendns.com（思科商业服务，见使用条款）&lt;/li&gt;
&lt;li&gt;dns.quad9.net（见隐私声明）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;平心而论，除个别例外，多数提供商都有较强的隐私声明。我最强烈的反对在于协议栈的破坏，以及浏览器无视本地网络配置擅自接管客户端存根解析器功能。这对需要严格管控网络协议的大型企业完全不可接受。&lt;/p&gt;
&lt;p&gt;这些DoH提供商大多也支持DoT。回到周一早晨的目标，我最终形成以下结论：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;强烈建议有能力者运行自己的内部DNS服务器&lt;/li&gt;
&lt;li&gt;需要保持诊断和监控内部DNS流量的能力&lt;/li&gt;
&lt;li&gt;自建DNS服务器可配置域名过滤服务（推荐Pi-Hole项目）&lt;/li&gt;
&lt;li&gt;警惕ISP将监控资本主义作为收入来源&lt;/li&gt;
&lt;li&gt;虽不愿破坏DNS原始的分布式美感，但强加密始终有益&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;我决定继续运行自己的DNS服务器，但使用DoT加密到Quad9的流量。Quad9似乎最具公益属性。同时通过iptables动态IP集阻止所有公共DoH提供商（需定期更新域名列表）。这意味着直接阻止到特定IP的TCP 443流量——就因为有人觉得协议混用是个好主意（叹气）。&lt;/p&gt;
&lt;h3 id=&#34;stubby部署&#34;&gt;Stubby部署
&lt;/h3&gt;&lt;p&gt;我的边界防火墙基于Ubuntu，需要找到能监听DNS请求并通过DoT转发到Quad9的软件。选择使用名为&amp;quot;Stubby&amp;quot;的DNS隐私守护进程（https://dnsprivacy.org）。安装命令：&lt;code&gt;sudo apt install stubby&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;Stubby作为本地DNS隐私存根解析器，通过TLS连接发送加密查询。其配置文件为/etc/stubby/stubby.yml，Quad9提供了现成配置（参考其支持文档）。关键配置包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;tls_authentication: GETDNS_AUTHENTICATION_REQUIRED&lt;/code&gt;：强制使用TLS且无回退&lt;/li&gt;
&lt;li&gt;&lt;code&gt;tls_query_padding_blocksize: 128&lt;/code&gt;：使用EDNS0填充隐藏查询尺寸&lt;/li&gt;
&lt;li&gt;&lt;code&gt;edns_client_subnet_private: 1&lt;/code&gt;：阻止发送客户端子网信息&lt;/li&gt;
&lt;li&gt;&lt;code&gt;round_robin_upstreams: 1&lt;/code&gt;：轮询上游服务器&lt;/li&gt;
&lt;li&gt;&lt;code&gt;idle_timeout: 10000&lt;/code&gt;：保持TCP连接降低开销&lt;/li&gt;
&lt;li&gt;&lt;code&gt;listen_addresses: 127.0.0.1@8053&lt;/code&gt;：绑定本地端口供Bind9使用&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;bind9配置&#34;&gt;Bind9配置
&lt;/h3&gt;&lt;p&gt;修改Bind配置使其将请求&amp;quot;转发&amp;quot;到本地Stubby实例。有两种选择：&lt;code&gt;forward only&lt;/code&gt;（仅转发）或&lt;code&gt;forward first&lt;/code&gt;（转发失败时回退标准DNS）。我的配置采用后者，在/etc/bind/named.conf的options部分添加转发地址。&lt;/p&gt;
&lt;p&gt;确保Stubby运行并启用开机自启：&lt;code&gt;systemctl enable stubby&lt;/code&gt;。最后用&lt;code&gt;rndc reload&lt;/code&gt;重载Bind，现在发往互联网的DNS流量已加密至Quad9。&lt;/p&gt;
&lt;h3 id=&#34;防火墙配置&#34;&gt;防火墙配置
&lt;/h3&gt;&lt;p&gt;使用iptables实施以下规则：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;允许出站TCP 853到Quad9地址&lt;/li&gt;
&lt;li&gt;创建包含常见DoH提供商的IP集并阻止其流量&lt;/li&gt;
&lt;li&gt;阻止任何端点绕过内部DNS服务器&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;维护DoH提供商IP集的脚本可通过定期DNS查询更新anycast地址。在crontab设置定时任务即可持续更新。&lt;/p&gt;
&lt;p&gt;假设防火墙是边界设备且执行NAT转发，需要添加规则阻止转发到DoH列表的流量。同时确保Stubby能出站与Quad9通信。最后关键规则是阻止内部网络（如10.0.0.0/8）端点直接访问外部DNS（如Google硬编码的8.8.8.8）。&lt;/p&gt;
&lt;p&gt;至此，我通过加密发往Quad9的DNS流量获得了暂时的安心，同时保留监控内部DNS流量的能力。这实现了加密、隐私、安全与运营可用性的平衡。祝你在应对DoH乱局的征途中一帆风顺！&lt;/p&gt;
</description>
        </item>
        
    </channel>
</rss>
