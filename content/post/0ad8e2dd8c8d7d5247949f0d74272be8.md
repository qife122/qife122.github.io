---
date: 2025-08-03T01:39:57+08:00
title: 通过Cloudflare实现域名伪装(ESNI技术解析)
tags: [网络安全, 域名伪装, ESNI, Cloudflare]
authors: qife
description: 本文深入探讨了如何利用Cloudflare CDN和ESNI(加密SNI)技术实现域名伪装，详细分析了HTTP/HTTPS请求中SNI字段的作用，并提供了完整的PoC验证过程，揭示了这种技术对网络监控带来的挑战。
---

# 通过Cloudflare实现域名伪装

在开始本文之前，我认为有必要先讨论"域名伪装"(Domain Fronting)这个术语及其可能的定义。如果您只关心如何隐藏通信内容，可以直接跳过本节。

## 定义"域名伪装"

从红队视角来看，域名伪装意味着将一个恶意网站的请求隐藏在看似访问无害网站的请求中。从技术角度，这可以描述为将网络层设置与特定虚拟主机的应用层请求解耦。如果观察者只能看到网络层指向"好"域名(或未被标记为恶意的域名)，那么攻击就成功了。

## 实际技术内容

当我发布关于域名伪装的基础文章时，@sehnaoui在推特上分享了链接，并收到Cloudflare解决方案工程团队负责人Suzanne的回复：

首先，我并未声称该技术在Cloudflare上有效，文中对Cloudflare的唯一提及是将其作为CDN的示例。

以下是使用文章中讨论的技术在Cloudflare上实现域名伪装的演示：

```bash
$ curl -s -H $'Host: frontmecf.vuln-demo.com' http://digininja.org.uk
<p>Vuln Demo site fronted by Cloudflare</p>
```

设置过程相当简单：我注册了Cloudflare账户，添加了digininja.org.uk域名并完成设置流程(包括将域名的NS记录转移到Cloudflare)。同时添加了vuln-demo.com账户但未完成设置，该域名保持"Pending Nameserver Update"状态。

为了证明这不是因为两个域名在同一账户下，我们尝试另一个由Cloudflare托管的知名域名：

```bash
$ curl -s -H $'Host: frontmecf.vuln-demo.com' http://cloudflare.com
<p>Vuln Demo site fronted by Cloudflare</p>
```

是的，我确实通过Cloudflare实现了域名伪装！

## HTTPS场景下的挑战

当我尝试在HTTPS上实现相同效果时，遇到了问题：

```bash
$ curl -s -H $'Host: frontmecf.vuln-demo.com' https://cloudflare.com
<html>
<head><title>403 Forbidden</title></head>
<body bgcolor="white">
<center><h1>403 Forbidden</h1></center>
<hr><center>cloudflare</center>
</body>
</html>
```

经过分析发现，Cloudflare在建立连接时会检查SNI(Server Name Indication)字段和Host头是否匹配。SNI在TLS握手过程中以明文形式发送，告知服务器应提供哪个证书。

## 使用ESNI技术突破限制

ESNI(Encrypted SNI)作为TLS 1.3规范的一部分，可以加密SNI信息。虽然ESNI是新兴技术，但OpenSSL开发者Stephen Farrell已经实现了相关功能。

以下是使用ESNI成功实现域名伪装的示例：

```bash
$ export LD_LIBRARY_PATH=/home/robin/src/openssl
$ ESNIRR=`dig +short txt _esni.www.cloudflare.com | sed -e 's/"//g'`

$ (cat get_digininja.org;sleep 5) | /home/robin/src/openssl/apps/openssl s_client \
-CApath /etc/ssl/certs/ -tls1_3 -connect www.cloudflare.com:443 -esni digininja.org.uk \
-esnirr $ESNIRR -esni_strict -servername www.cloudflare.com
```

通过Wireshark抓包分析确认，ESNI扩展(0xFFCE)中的信息确实被加密，不再暴露真实域名。

## 防御视角的启示

对于防御者而言，如果仅依赖DNS查询和SNI主机名进行监控，这些信息已不再可信，因为它们完全处于攻击者控制之下。

## 结论

无论您称之为域名伪装、域名隐藏还是其他名称，本文展示了如何利用ESNI和自定义Host头将"恶意"HTTP请求隐藏在看似"良性"的请求中。由于ESNI受到隐私倡导者的支持，这项技术可能会长期有效。同时能够在监控系统日志中留下虚假标记也是一个额外优势。