---
date: 2025-08-03T02:52:29+08:00
title: 为AKS VMSS配置主机级审计日志记录
tags: [Azure Kubernetes Service, 审计日志, 安全监控]
authors: qife
description: 本文详细介绍了如何在Azure Kubernetes Service (AKS)的虚拟机规模集(VMSS)上启用和配置Linux审计日志子系统auditd，以监控工作节点和容器内核级别的活动，包括进程创建、文件访问和命令行活动等。
---


本文指导您如何在Azure Kubernetes Service (AKS)虚拟机规模集(VMSS)上使用Linux审计子系统（也称为auditd）启用和配置Linux审计日志记录。

**警告**  
以下信息截至本文发布日期（2023年3月）是准确的，未来指南可能会有所变化。

与Kubernetes控制平面日志提供集群高级操作可见性不同，在集群上启用auditd日志记录可以让您查看AKS工作节点和容器内核级别的活动。这包括进程创建、文件访问和命令行活动等，对于发现集群上异常命令行活动和程序执行非常有价值。与容器级日志记录不同，这为您提供了底层工作节点上运行的负载的可见性，而不仅仅是运行在其上的容器化负载（包括容器逃逸和其他漏洞利用）。它具有高度可配置性，对于运行多租户集群尤其有价值。  
要了解Linux主机级审计日志记录（和Kubernetes控制平面日志记录）如何为集群提供有用的可见性，请查看我们在[Azure Kubernetes Service (AKS)威胁搜寻博客文章](https://example.com)和Jupyter笔记本中提供的威胁搜寻查询。

### 主机级审计日志记录流程

主机级审计日志记录利用多个Linux工具捕获审计日志并将其发送到Log Analytics工作区进行审查。


实现此目标的组件包括：

- **auditd**：Linux审计系统的守护进程。守护进程写入磁盘的审计事件由auditd.rules中定义的规则配置。
- **audisp**：审计事件多路复用器，可用于将auditd事件数据分发到syslog等数据收集服务器。
- **syslog**：将日志转发到Linux的Log Analytics代理（OMS）。可以通过Azure门户或管理主机上的配置文件配置syslog转发的事件的设施和严重性。
- **auoms**：Microsoft审计收集工具，可以使用auoms配置中定义的处理规则来收集和过滤auditd/audisp事件数据。
- **Log Analytics工作区**：您可以使用Kusto查询语言（KQL）探索来自Azure资源和服务的遥测数据。

### 如何在AKS VMSS上启用auditd日志记录

**警告**  
以下内容指导您完成在AKS集群上设置auditd日志记录的手动步骤。然而，这需要您在集群中的每个工作节点上安装auditd，并且在集群自动扩展后配置将被删除。为避免这种情况，我们建议您使用[aks-auditd](https://example.com)自动在集群上设置此日志记录，或使用自定义脚本扩展。aks-auditd还支持节点重新映像和自动扩展，而手动配置不支持。

1. **在AKS集群VMSS上启用Linux Operations Management Suite (OMS)代理（auoms）**，运行以下命令：
   ```bash
   az vmss extension set \
     --resource-group $RESOURCE_GROUP \
     --vmss-name $VMSS_NAME \
     --name OmsAgentForLinux \
     --publisher Microsoft.EnterpriseCloud.Monitoring \
     --protected-settings '{\"workspaceKey\":\"<KEY>\"}' \
     --settings '{\"workspaceId\":\"<ID>",\"skipDockerProviderInstall\":true}'
   ```
   您的集群的vmss-name将以aks-agentpool开头，并属于以MC_开头的管理资源组，如下面的截图所示。


   workspaceId和workspaceKey可以在Log Analytics工作区内的“代理管理”选项卡中找到，如下面的截图所示。workspaceKey对应于下面突出显示的“主键”。


2. **通过Azure门户触发VM更新**（选择每个实例并选择升级）。

3. **在VMSS工作节点上安装auditd**。为此，您需要部署或获取一个在集群上运行的特权Pod，该Pod可以访问底层工作节点的文件系统和进程ID命名空间。您可以通过以下方式实现：

   - **部署一个Pod**，其规范将hostPath卷挂载到容器环境中。
   - **在Pod规范中包含securityContext字段**并启用特权模式。
   - **配置主机进程ID命名空间共享**，通过在Pod规范中包含hostPID字段并启用它。

   ```yaml
   apiVersion: v1
   kind: Pod
   metadata:
     name: privileged-pod
   spec:
     hostPID: true
     containers:
       - name: priv-host-mount
         image: alpine:latest
         command:
           - /bin/sh
           - -c
           - -
         args:
           - while true; do sleep 30; done;
         securityContext:
           privileged: true
         volumeMounts:
           - name: privmount
             mountPath: /workernode
     volumes:
       - name: privmount
         hostPath:
           path: /
           type: Directory
   ```

   - **使用kubectl exec**获取到Pod上运行容器的交互式shell，使用chroot模拟对底层虚拟机的访问并安装auditd，如下所示。
     ```bash
     kubectl exec -it $POD /bin/sh
     > chroot /workernode
     > apt-get update && apt-get install auditd -y
     ```

4. **配置auditd规则**：

   - 添加一个规则来监控进程执行。您可以通过在以下路径创建一个名为10-procmon.rules的文件：/etc/audit/rules.d/10-procmon.rules，并添加以下内容来实现。更详细的配置信息可以在[这里](https://example.com)找到。
     ```
     -a exit,always -F arch=b64 -S execve -k procmon
     -a exit,always -F arch=b32 -S execve -k procmon
     ```
   - 通过运行`systemctl restart auditd`更新auditd守护进程。

5. **更新syslog插件设施设置**，以更新audisp将auditd记录定向到syslog。为此，您需要更新/etc/audisp/plugins.d/syslog.conf中的配置，并将active字段设置为yes，如下面的截图所示。

   默认情况下，syslog启用的设施是user设施。如果您想更改此设置，可以更改ARGS中的第二个参数（第一个参数是日志级别）。例如，以下配置将syslog设施更改为authpriv。

   ```
   active = yes
   direction = out
   path = builtin_syslog
   type = builtin
   args = LOG_INFO LOG_AUTHPRIV
   format = string
   ```

   使用`systemctl restart auditd`重新启动auditd守护进程以应用更改。

6. **在门户中转到Log Analytics工作区**，并配置日志代理以接受authpriv设施的INFO级别的syslog事件。为此：

   - 导航到“设置”>“代理配置”
   - 选择“Syslog”
   - 选择“+添加设施”
   - 在下拉菜单中选择authpriv，如下所示。
