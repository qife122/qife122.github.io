---
date: 2025-08-06T02:39:11+08:00
title: "可信发布：软件包安全的新标杆——基于OpenID Connect的无密钥认证机制"
tags: [供应链安全, 身份认证, PyPI, CI/CD]
authors: qife
description: "本文深入解析PyPI采用的可信发布技术，通过OpenID Connect实现无长期API令牌的自动化发布流程，显著降低凭证泄露风险，并探讨该机制如何防范账户劫持、供应链攻击等新型威胁。"
---

## 可信发布：技术原理

可信发布本质上是一种新型认证机制，其核心创新在于**无需预共享密钥**。该技术基于OpenID Connect（OIDC）标准构建，利用OAuth2框架实现身份声明验证：

1. **OIDC工作流程**：
   - GitHub Actions等CI平台作为身份提供商（IdP）
   - 生成包含工作流元数据的JWT令牌（含数字签名）
   - 典型声明包括仓库路径、工作流文件名、触发用户等

2. **信任建立阶段**：
   ```yaml
   # PyPI项目需预先配置的信任关系示例
   trusted_publishers:
     - provider: github
       repository: "hamilcar/cartago"
       workflow: "release.yml"
       environment: "production"
   ```

## 安全优势对比

| 维度                | 传统API令牌                     | 可信发布系统                  |
|---------------------|-------------------------------|-----------------------------|
| 凭证生命周期        | 长期有效（需手动撤销）          | 临时令牌（自动过期）          |
| 攻击面              | 所有CI步骤可读取                | 仅限指定工作流环境            |
| 泄露恢复            | 需人工撤销并重新部署            | 攻击者失去访问即自动失效      |

## 威胁模型创新

1. **防范账户复活攻击**：
   - 绑定GitHub用户稳定ID（非用户名）
   - 即使攻击者接管旧用户名也无法通过验证

2. **精细化权限控制**：
   ```python
   # PyPI实现的发布权限分离示例
   if token.claims.get("environment") != "verified":
       raise PublisherAuthorizationError
   ```

## 实施案例

GitHub Actions发布流程：
1. 工作流触发时获取OIDC令牌（通过`actions/id-token@v1`）
2. PyPI验证令牌签名及声明匹配
3. 颁发15分钟有效期的临时API令牌
4. 使用`twine upload`完成发布

## 未来展望

该技术可扩展至：
- Rust Crates
- RubyGems
- NPM等生态
其临时凭证特性为构建审计溯源系统奠定基础，如验证发布版本与源码的密码学对应关系。